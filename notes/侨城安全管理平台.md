# 侨城安全管理平台

## 登录页：LoginActivity



## MainActivity

### 首页：HomeFragment



### 工作台：WorkbenchFragment

#### 安全任务检查：SecurityInspectionTaskActivity

​	使用Navigation作为导航，实现单activity多fragment的架构。

​	navigation导航：因为其内部维护了一个导航栈，所以使用一个空白页面作为该导航的首页，维护一个标记，让其自动finish；因为想要该导航的一个返回功能，而顶级目的地默认不显示，所以添加一个顶级目的地。

```java
//navigation使用
//获取navController
NavController navController = Navigation.findNavController(this,R.id.fragment);
//设置工具栏的一些配置，这里设置顶级目的地为在导航图里id为workBlankFragment的页面
AppBarConfiguration configuration = new AppBarConfiguration.Builder(R.id.workBlankFragment)
                .build();
Toolbar toolbar = findViewById(R.id.toolbar);
//使用navigationui更新界面
NavigationUI.setupWithNavController(toolbar,navController,configuration);
```



##### SecurityInspectionTaskFragment

- 使用TabLayout和ViewPager2实现待检查和已检查的切换

```java
		//tab的标题
        String[] tabs = new String[]{"待检查","已检查"};
        //关联TabLayout和ViewPager2
        new TabLayoutMediator(binding.tabLayout, binding.viewPager, new TabLayoutMediator.TabConfigurationStrategy() {
            @Override
            public void onConfigureTab(@NonNull TabLayout.Tab tab, int position) {
                tab.setText(tabs[position]);
            }
        }).attach();
```



- viewpager2的adapter：SecurityInspectionTaskAdapter

```java
SecurityInspectionTaskAdapter adapter = new SecurityInspectionTaskAdapter(this);
        binding.viewPager.setAdapter(adapter);
```



- adapter填充：InspectionListFragment

```java
//继承自FragmentStateAdapter
SecurityInspectionTaskAdapter extends FragmentStateAdapter
//创建fragment 传入相应位置参数 让其显示对应内容
InspectionListFragment fragment = new InspectionListFragment();
        Bundle args = new Bundle();
        args.putInt("position",position);
        fragment.setArguments(args);
```



- InspectionListFragment根据传递的position不同，recyclerview显示不同布局

```java
		Bundle bundle = getArguments();
        int position = bundle.getInt("position");
		//根据position显示不同内容
        if (position == 0){
            showNotCheckView();
        }else {
            showCheckedView();
        }
```



### 消息：MessageFragment



### 我的：MineFragment



## 隐患整改：

分详情和整改页面：

详情：未整改、不通过、已验收

整改：整改、验收、验收驳回整改





登录信息：

{
    "code": "0",
    "msg": "操作成功！",
    "data": {
        "makeMenus": [
            {
                "menuId": 3,
                "menuSort": 1,
                "menuParentId": 0,
                "menuRequestUrl": "safety",
                "name": "safety",
                "title": "安全十三项",
                "children": []
            },
            {
                "menuId": 2,
                "menuSort": 2,
                "menuParentId": 0,
                "menuRequestUrl": "sys",
                "name": "sys",
                "title": "系统设置",
                "children": [
                    {
                        "menuId": 5,
                        "menuSort": 1,
                        "menuParentId": 2,
                        "menuRequestUrl": "user",
                        "name": "user",
                        "title": "用户管理",
                        "children": []
                    },
                    {
                        "menuId": 4,
                        "menuSort": 2,
                        "menuParentId": 2,
                        "menuRequestUrl": "org",
                        "name": "org",
                        "title": "组织架构",
                        "children": []
                    }
                ]
            }
        ],
        "roleIds": "2",
        "menus": "2,3,4,5",
        "info": {
            "userCompanyName": "青柠互动二号",
            "userOrg": "4",
            "picServer": "https://qn-test.oss-cn-shenzhen.aliyuncs.com",
            "userAvatar": "1",
            "userNickname": "humz",
            "userCompany": "2",
            "userName": "humz",
            "userId": "4"
        },
        "token": "c85150fc-2b21-43a3-b6af-17e9888cb407"
    }
}

![image-20200410195953292](C:\Users\abc\AppData\Roaming\Typora\typora-user-images\image-20200410195953292.png)



提交整改接口参数：

{
    "hiddenTroubleId":"3",
    "rectificationContent":"已整改 请验收",
    "rectificationJson":"[{'fileName':'整改图片1.jpg','fileUrl':'整改图片1.jpg','fileSize':'758'},{'fileName':'整改图片2.jpg','fileUrl':'整改图片2.jpg','fileSize':'685'}]"
}

需要序列化map 生成Json数据



## 文件上传

### 文件上传接口

请求类型：post

接口：/upload/uploadFile.do

请求参数：file:Object

尝试：好像可以使用form表单  不能的话使用json字符串

相应data返回数组

[

{codeUrl:文件相对路径,

fileName:文件原名称

filesize:文件大小

}

]

### 获取aliyun图片地址

请求类型：get

接口：/upload/picServer.do

参数应该就是文件上传返回的数组里的url地址

## Json字符串转换工具

```java
package com.neoqee.apitest.octsafe;

import com.google.gson.JsonArray;
import com.google.gson.JsonObject;

import java.util.List;
import java.util.Map;

/**
 * post请求需要用json传送，将本地用map组装的参数转换成json字符串
 * */
public class HttpUtil {

    public static String transformToJson(Map<String,Object> params){
        JsonObject jsonObject = new JsonObject();
        for (String s : params.keySet()) {
            if (params.get(s) instanceof List){
                JsonArray jsonArray = new JsonArray();
                for (Map<String, Object> map : ((List<Map<String, Object>>) params.get(s))) {
                    jsonArray.add(transform(map));
                }
                jsonObject.addProperty(s,jsonArray.toString());
            }
            else if (params.get(s) instanceof Map){
                JsonObject transform = transform((Map<String, Object>) params.get(s));
                jsonObject.addProperty(s,transform.toString());
            }
            else {
                jsonObject.addProperty(s,params.get(s).toString());
            }
        }
        return jsonObject.toString();
    }

    private static JsonObject transform(Map<String,Object> params){
        JsonObject jsonObject = new JsonObject();
        for (String s : params.keySet()) {
            jsonObject.addProperty(s,params.get(s).toString());
        }
        System.out.println(jsonObject.toString());
        return jsonObject;
    }

}
```

